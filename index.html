<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>AR Swipe Stack</title>

  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.0/dist/mindar-image-aframe.prod.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      position: fixed;
      overflow: hidden !important;
      background: #000;
      overscroll-behavior: none !important;
      touch-action: none !important;
      -webkit-user-select: none;
      user-select: none;
    }

    #touch-overlay {
      position: fixed;
      top:0; left:0;
      width:100vw; height:100vh;
      z-index:9999;
      background:transparent;
      touch-action:none;
    }
  </style>
</head>
<body>

<div id="touch-overlay"></div>

<script>
/* ------------------ IMAGE LIST ------------------ */
const IMAGES = [
  'img1.jpg','img2.jpg','img3.jpg','img4.jpg','img5.jpg',
  'img6.jpg','img7.jpg','img8.jpg','img9.jpg','img10.jpg'
];

/* ------------------ PRODUCT LINKS ------------------ */
const LINKS = [
  "https://example.com/p1",
  "https://example.com/p2",
  "https://example.com/p3",
  "https://example.com/p4",
  "https://example.com/p5",
  "https://example.com/p6",
  "https://example.com/p7",
  "https://example.com/p8",
  "https://example.com/p9",
  "https://example.com/p10"
];

/* PRELOAD IMAGES */
IMAGES.forEach(src => { const i = new Image(); i.src = src; });

/* ========================================================
   GESTURE DETECTOR (Swipe + Tap)
   ======================================================== */
class GestureDetector {
  constructor(overlay, {onDrag, onRelease, onSwipe, onTap}) {
    this.onDrag = onDrag;
    this.onRelease = onRelease;
    this.onSwipe = onSwipe;
    this.onTap = onTap;

    // TOUCH
    overlay.addEventListener("touchstart", e => this.start(e.touches[0].clientX), { passive:false });
    overlay.addEventListener("touchmove", e => { e.preventDefault(); this.move(e.touches[0].clientX) }, { passive:false });
    overlay.addEventListener("touchend", e => this.end(e.changedTouches[0].clientX));

    // MOUSE / POINTER
    overlay.addEventListener("pointerdown", e => this.start(e.clientX));
    overlay.addEventListener("pointermove", e => this.move(e.clientX));
    overlay.addEventListener("pointerup", e => this.end(e.clientX));
  }

  start(x) {
    this.startX = x;
    this.lastX = x;
    this.startT = Date.now();
    this.active = true;
  }

  move(x) {
    if (!this.active) return;
    this.lastX = x;
    if (this.onDrag) this.onDrag(x - this.startX);
  }

  end(x) {
    if (!this.active) return;
    this.active = false;

    const dist = x - this.startX;
    const t = Date.now() - this.startT;
    const fast = Math.abs(dist) / (t + 1);

    /* -------- TAP DETECTION -------- */
    if (Math.abs(dist) < 10 && t < 250) {
      if (this.onTap) this.onTap();
      return;
    }

    /* -------- SWIPE DETECTION -------- */
    if (Math.abs(dist) > 60 || fast > 0.4) {
      this.onSwipe(dist > 0 ? "RIGHT" : "LEFT");
    } else {
      this.onRelease();
    }
  }
}

/* ========================================================
   SWIPER COMPONENT
   ======================================================== */
AFRAME.registerComponent("stack-swiper", {
  init: function() {
    this.ptr = 0;
    this.nextPtr = 1;
    this.total = IMAGES.length;
    this.busy = false;

    this.makeCards();

    this.gesture = new GestureDetector(
      document.getElementById("touch-overlay"),
      {
        onDrag: dx => this.drag(dx),
        onRelease: () => this.reset(),
        onSwipe: dir => this.pop(dir),

        // NEW: Tap event
        onTap: () => this.openLink()
      }
    );

    this.el.setAttribute("visible", false);
  },

  makeCards() {
    this.front = document.createElement("a-image");
    this.front.setAttribute("width", "1");
    this.front.setAttribute("height", "1.3");
    this.front.setAttribute("position", "0 0 0.05");
    this.el.appendChild(this.front);

    this.back = document.createElement("a-image");
    this.back.setAttribute("width", "1");
    this.back.setAttribute("height", "1.3");
    this.back.setAttribute("position", "0 -0.02 0");
    this.el.appendChild(this.back);

    this.front.setAttribute("src", IMAGES[this.ptr]);
    this.back.setAttribute("src", IMAGES[this.nextPtr]);
  },

  drag(dx) {
    if (this.busy) return;
    let max = 0.6;
    let x = Math.max(-max, Math.min(max, dx / 200));
    let rot = (dx / 200) * -12;

    this.front.setAttribute("position", `${x} 0 0.05`);
    this.front.setAttribute("rotation", `0 0 ${rot}`);
  },

  reset() {
    if (this.busy) return;

    this.front.setAttribute("animation__back", {
      property: "position",
      to: "0 0 0.05",
      dur: 180,
      easing: "easeOutQuad"
    });

    this.front.setAttribute("animation__rot", {
      property: "rotation",
      to: "0 0 0",
      dur: 180,
      easing: "easeOutQuad"
    });
  },

  openLink() {
    const url = LINKS[this.ptr];
    if (url) window.open(url, "_blank");
  },

  pop(dir) {
    if (this.busy) return;
    this.busy = true;

    const sign = dir === "LEFT" ? -1 : 1;

    this.front.setAttribute("animation__exit", {
      property: "position",
      to: `${1.8 * sign} 0 0.05`,
      dur: 260,
      easing: "easeInQuad"
    });

    this.front.setAttribute("animation__exitrot", {
      property: "rotation",
      to: `0 0 ${-40 * sign}`,
      dur: 260,
      easing: "easeInQuad"
    });

    setTimeout(() => {
      this.ptr = (this.ptr + 1) % this.total;
      this.nextPtr = (this.ptr + 1) % this.total;

      this.front.setAttribute("src", IMAGES[this.ptr]);
      this.back.setAttribute("src", IMAGES[this.nextPtr]);

      this.front.setAttribute("position", "0 0 0.05");
      this.front.setAttribute("rotation", "0 0 0");

      this.busy = false;
    }, 280);
  }
});
</script>


<!-- ========================================================
     AR SCENE
======================================================== -->
<a-scene
  mindar-image="imageTargetSrc: targets.mind; autoStart: true; uiScanning: yes;"
  embedded
  color-space="sRGB"
  renderer="precision: high; antialias: true"
  vr-mode-ui="enabled: false"
  device-orientation-permission-ui="enabled: false">

  <a-camera look-controls="enabled:false"></a-camera>

  <a-entity id="target" mindar-image-target="targetIndex: 0">
    <a-entity id="stack" position="0 0.15 0.12" stack-swiper></a-entity>
  </a-entity>
</a-scene>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const target = document.getElementById("target");
  const stack = document.getElementById("stack");

  target.addEventListener("targetFound", () => stack.setAttribute("visible", true));
  target.addEventListener("targetLost", () => stack.setAttribute("visible", false));
});
</script>

</body>
</html>
