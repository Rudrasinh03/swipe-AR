<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.0/dist/mindar-image-aframe.prod.js"></script>

    <style>
        body { margin: 0; overflow: hidden; }

        #ar-scene { width: 100vw; height: 100vh; }

        /* Full screen swipe catcher */
        #touch-overlay {
            position: fixed;
            top: 0; left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 20;
            background: transparent;
        }
    </style>
</head>

<body>

<!-- MUST BE ABOVE SCRIPTS -->
<div id="touch-overlay"></div>

<script>
/* ------------------- SWIPE DETECTOR ------------------- */
document.addEventListener("DOMContentLoaded", () => {
    const overlay = document.getElementById("touch-overlay");
    let startX = null;
    const threshold = 60;

    overlay.addEventListener("touchstart", (evt) => {
        startX = evt.touches[0].clientX;
    });

    overlay.addEventListener("touchend", (evt) => {
        if (startX === null) return;
        const endX = evt.changedTouches[0].clientX;
        const diff = endX - startX;
        startX = null;

        let direction = null;
        if (diff > threshold) direction = "RIGHT";
        if (diff < -threshold) direction = "LEFT";

        if (direction) {
            overlay.dispatchEvent(
                new CustomEvent("swipe", { detail: { direction } })
            );
        }
    });
});

/* ------------------- CAROUSEL ------------------- */
AFRAME.registerComponent("ar-carousel", {
    init: function () {
        this.total = 10;
        this.index = 1;
        this.isAnimating = false;
        this.speed = 200;

        this.showSlide(this.index);

        document
            .getElementById("touch-overlay")
            .addEventListener("swipe", (e) => this.handleSwipe(e));
    },

    showSlide(i) {
        for (let n = 1; n <= this.total; n++) {
            const el = document.querySelector("#slide" + n);
            if (el) {
                el.setAttribute("visible", n === i);
                el.setAttribute("material", "opacity", n === i ? 1 : 0);
            }
        }
    },

    handleSwipe(evt) {
        const dir = evt.detail.direction;
        this.animateSlide(dir);
    },

    animateSlide(direction) {
        if (this.isAnimating) return;
        this.isAnimating = true;

        let next =
            direction === "LEFT"
                ? this.index === 10 ? 1 : this.index + 1
                : this.index === 1 ? 10 : this.index - 1;

        const currentEl = document.querySelector("#slide" + this.index);
        const nextEl = document.querySelector("#slide" + next);

        currentEl.setAttribute("animation__fadeout", {
            property: "material.opacity",
            to: 0,
            dur: this.speed,
            easing: "linear",
        });

        setTimeout(() => {
            currentEl.setAttribute("visible", false);
            this.index = next;

            nextEl.setAttribute("visible", true);
            nextEl.setAttribute("material", "opacity", 0);

            nextEl.setAttribute("animation__fadein", {
                property: "material.opacity",
                to: 1,
                dur: this.speed,
                easing: "linear",
            });

            setTimeout(() => (this.isAnimating = false), this.speed);
        }, this.speed);
    },
});
</script>

<!-- ------------------- AR SCENE ------------------- -->
<a-scene
    id="ar-scene"
    mindar-image="imageTargetSrc: targets.mind; autoStart: true; uiScanning: yes;"
    color-space="sRGB"
    embedded
    renderer="precision: high; antialias: true;"
    vr-mode-ui="enabled: false"
    device-orientation-permission-ui="enabled: false">

    <a-assets timeout="5000">
        <img id="img1"  src="img1.jpg" />
        <img id="img2"  src="img2.jpg" />
        <img id="img3"  src="img3.jpg" />
        <img id="img4"  src="img4.jpg" />
        <img id="img5"  src="img5.jpg" />
        <img id="img6"  src="img6.jpg" />
        <img id="img7"  src="img7.jpg" />
        <img id="img8"  src="img8.jpg" />
        <img id="img9"  src="img9.jpg" />
        <img id="img10" src="img10.jpg" />
    </a-assets>

    <a-camera look-controls="enabled: false"></a-camera>

    <a-entity mindar-image-target="targetIndex: 0" id="target">

        <!-- Show carousel only when target is visible -->
        <a-entity id="carousel"
            position="0 0.3 0.1"
            rotation="-20 0 0"
            visible="false"
            ar-carousel>

            <a-plane width="1.05" height="1.45" color="#fff" position="0 0 0" material="shader: flat"></a-plane>

            <a-image id="slide1"  src="#img1"  width="1" height="1.3" position="0 0 0.02"></a-image>
            <a-image id="slide2"  src="#img2"  width="1" height="1.3" position="0 0 0.02" visible="false"></a-image>
            <a-image id="slide3"  src="#img3"  width="1" height="1.3" position="0 0 0.02" visible="false"></a-image>
            <a-image id="slide4"  src="#img4"  width="1" height="1.3" position="0 0 0.02" visible="false"></a-image>
            <a-image id="slide5"  src="#img5"  width="1" height="1.3" position="0 0 0.02" visible="false"></a-image>
            <a-image id="slide6"  src="#img6"  width="1" height="1.3" position="0 0 0.02" visible="false"></a-image>
            <a-image id="slide7"  src="#img7"  width="1" height="1.3" position="0 0 0.02" visible="false"></a-image>
            <a-image id="slide8"  src="#img8"  width="1" height="1.3" position="0 0 0.02" visible="false"></a-image>
            <a-image id="slide9"  src="#img9"  width="1" height="1.3" position="0 0 0.02" visible="false"></a-image>
            <a-image id="slide10" src="#img10" width="1" height="1.3" position="0 0 0.02" visible="false"></a-image>

        </a-entity>

    </a-entity>

</a-scene>

<script>
/* Show/hide carousel when marker found/lost */
document.querySelector("#target").addEventListener("targetFound", () => {
    document.querySelector("#carousel").setAttribute("visible", true);
});

document.querySelector("#target").addEventListener("targetLost", () => {
    document.querySelector("#carousel").setAttribute("visible", false);
});
</script>

</body>
</html>
